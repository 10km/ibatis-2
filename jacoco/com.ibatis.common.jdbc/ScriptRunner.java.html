<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScriptRunner.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mybatis2</a> &gt; <a href="index.source.html" class="el_package">com.ibatis.common.jdbc</a> &gt; <span class="el_source">ScriptRunner.java</span></div><h1>ScriptRunner.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2004-2020 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.ibatis.common.jdbc;

import java.io.IOException;
import java.io.LineNumberReader;
import java.io.PrintWriter;
import java.io.Reader;
import java.sql.Connection;
import java.sql.Driver;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;

import com.ibatis.common.resources.Resources;

/**
 * Tool to run database scripts.
 */
public class ScriptRunner {

  /** The Constant DEFAULT_DELIMITER. */
  private static final String DEFAULT_DELIMITER = &quot;;&quot;;

  /** The connection. */
  private Connection connection;

  /** The driver. */
  private String driver;

  /** The url. */
  private String url;

  /** The username. */
  private String username;

  /** The password. */
  private String password;

  /** The stop on error. */
  private boolean stopOnError;

  /** The auto commit. */
  private boolean autoCommit;

  /** The log writer. */
<span class="pc" id="L62">  private PrintWriter logWriter = new PrintWriter(System.out);</span>

  /** The error log writer. */
<span class="pc" id="L65">  private PrintWriter errorLogWriter = new PrintWriter(System.err);</span>

  /** The delimiter. */
<span class="pc" id="L68">  private String delimiter = DEFAULT_DELIMITER;</span>

  /** The full line delimiter. */
<span class="pc" id="L71">  private boolean fullLineDelimiter = false;</span>

  /**
   * Default constructor.
   *
   * @param connection
   *          the connection
   * @param autoCommit
   *          the auto commit
   * @param stopOnError
   *          the stop on error
   */
<span class="fc" id="L83">  public ScriptRunner(Connection connection, boolean autoCommit, boolean stopOnError) {</span>
<span class="fc" id="L84">    this.connection = connection;</span>
<span class="fc" id="L85">    this.autoCommit = autoCommit;</span>
<span class="fc" id="L86">    this.stopOnError = stopOnError;</span>
<span class="fc" id="L87">  }</span>

  /**
   * Sets the delimiter.
   *
   * @param delimiter
   *          the delimiter
   * @param fullLineDelimiter
   *          the full line delimiter
   */
  public void setDelimiter(String delimiter, boolean fullLineDelimiter) {
<span class="nc" id="L98">    this.delimiter = delimiter;</span>
<span class="nc" id="L99">    this.fullLineDelimiter = fullLineDelimiter;</span>
<span class="nc" id="L100">  }</span>

  /**
   * Instantiates a new script runner.
   *
   * @param driver
   *          the driver
   * @param url
   *          the url
   * @param username
   *          the username
   * @param password
   *          the password
   * @param autoCommit
   *          the auto commit
   * @param stopOnError
   *          the stop on error
   */
  public ScriptRunner(String driver, String url, String username, String password, boolean autoCommit,
<span class="nc" id="L119">      boolean stopOnError) {</span>
<span class="nc" id="L120">    this.driver = driver;</span>
<span class="nc" id="L121">    this.url = url;</span>
<span class="nc" id="L122">    this.username = username;</span>
<span class="nc" id="L123">    this.password = password;</span>
<span class="nc" id="L124">    this.autoCommit = autoCommit;</span>
<span class="nc" id="L125">    this.stopOnError = stopOnError;</span>
<span class="nc" id="L126">  }</span>

  /**
   * Setter for logWriter property.
   *
   * @param logWriter
   *          - the new value of the logWriter property
   */
  public void setLogWriter(PrintWriter logWriter) {
<span class="fc" id="L135">    this.logWriter = logWriter;</span>
<span class="fc" id="L136">  }</span>

  /**
   * Setter for errorLogWriter property.
   *
   * @param errorLogWriter
   *          - the new value of the errorLogWriter property
   */
  public void setErrorLogWriter(PrintWriter errorLogWriter) {
<span class="fc" id="L145">    this.errorLogWriter = errorLogWriter;</span>
<span class="fc" id="L146">  }</span>

  /**
   * Runs an SQL script (read in using the Reader parameter).
   *
   * @param reader
   *          - the source of the script
   * @throws IOException
   *           Signals that an I/O exception has occurred.
   * @throws SQLException
   *           the SQL exception
   */
  public void runScript(Reader reader) throws IOException, SQLException {
    try {
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">      if (connection == null) {</span>
<span class="nc" id="L161">        DriverManager.registerDriver((Driver) Resources.instantiate(driver));</span>
<span class="nc" id="L162">        Connection conn = DriverManager.getConnection(url, username, password);</span>
        try {
<span class="nc bnc" id="L164" title="All 2 branches missed.">          if (conn.getAutoCommit() != autoCommit) {</span>
<span class="nc" id="L165">            conn.setAutoCommit(autoCommit);</span>
          }
<span class="nc" id="L167">          runScript(conn, reader);</span>
        } finally {
<span class="nc" id="L169">          conn.close();</span>
        }
<span class="nc" id="L171">      } else {</span>
<span class="fc" id="L172">        boolean originalAutoCommit = connection.getAutoCommit();</span>
        try {
<span class="fc bfc" id="L174" title="All 2 branches covered.">          if (originalAutoCommit != this.autoCommit) {</span>
<span class="fc" id="L175">            connection.setAutoCommit(this.autoCommit);</span>
          }
<span class="fc" id="L177">          runScript(connection, reader);</span>
        } finally {
<span class="fc" id="L179">          connection.setAutoCommit(originalAutoCommit);</span>
        }
      }
<span class="nc" id="L182">    } catch (IOException e) {</span>
<span class="nc" id="L183">      throw e;</span>
<span class="nc" id="L184">    } catch (SQLException e) {</span>
<span class="nc" id="L185">      throw e;</span>
<span class="nc" id="L186">    } catch (Exception e) {</span>
<span class="nc" id="L187">      throw new RuntimeException(&quot;Error running script.  Cause: &quot; + e, e);</span>
<span class="fc" id="L188">    }</span>
<span class="fc" id="L189">  }</span>

  /**
   * Runs an SQL script (read in using the Reader parameter) using the connection passed in.
   *
   * @param conn
   *          - the connection to use for the script
   * @param reader
   *          - the source of the script
   * @throws IOException
   *           if there is an error reading from the Reader
   * @throws SQLException
   *           if any SQL errors occur
   */
  private void runScript(Connection conn, Reader reader) throws IOException, SQLException {
<span class="fc" id="L204">    StringBuilder command = null;</span>
    try {
<span class="fc" id="L206">      LineNumberReader lineReader = new LineNumberReader(reader);</span>
<span class="fc" id="L207">      String line = null;</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">      while ((line = lineReader.readLine()) != null) {</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">        if (command == null) {</span>
<span class="fc" id="L210">          command = new StringBuilder();</span>
        }
<span class="fc" id="L212">        String trimmedLine = line.trim();</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        if (trimmedLine.startsWith(&quot;--&quot;)) {</span>
<span class="fc" id="L214">          println(trimmedLine);</span>
<span class="pc bpc" id="L215" title="1 of 4 branches missed.">        } else if (trimmedLine.length() &lt; 1 || trimmedLine.startsWith(&quot;//&quot;)) {</span>
          // Do nothing
<span class="pc bpc" id="L217" title="2 of 4 branches missed.">        } else if (trimmedLine.length() &lt; 1 || trimmedLine.startsWith(&quot;--&quot;)) {</span>
          // Do nothing
<span class="pc bpc" id="L219" title="2 of 6 branches missed.">        } else if (!fullLineDelimiter &amp;&amp; trimmedLine.endsWith(getDelimiter())</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            || fullLineDelimiter &amp;&amp; trimmedLine.equals(getDelimiter())) {</span>
<span class="fc" id="L221">          command.append(line.substring(0, line.lastIndexOf(getDelimiter())));</span>
<span class="fc" id="L222">          command.append(&quot; &quot;);</span>
<span class="fc" id="L223">          Statement statement = conn.createStatement();</span>

<span class="fc" id="L225">          println(command);</span>

<span class="fc" id="L227">          boolean hasResults = false;</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">          if (stopOnError) {</span>
<span class="nc" id="L229">            hasResults = statement.execute(command.toString());</span>
          } else {
            try {
<span class="fc" id="L232">              statement.execute(command.toString());</span>
<span class="fc" id="L233">            } catch (SQLException e) {</span>
<span class="fc" id="L234">              e.fillInStackTrace();</span>
<span class="fc" id="L235">              printlnError(&quot;Error executing: &quot; + command);</span>
<span class="fc" id="L236">              printlnError(e);</span>
<span class="fc" id="L237">            }</span>
          }

<span class="pc bpc" id="L240" title="3 of 4 branches missed.">          if (autoCommit &amp;&amp; !conn.getAutoCommit()) {</span>
<span class="nc" id="L241">            conn.commit();</span>
          }

<span class="fc" id="L244">          ResultSet rs = statement.getResultSet();</span>
<span class="pc bpc" id="L245" title="3 of 4 branches missed.">          if (hasResults &amp;&amp; rs != null) {</span>
<span class="nc" id="L246">            ResultSetMetaData md = rs.getMetaData();</span>
<span class="nc" id="L247">            int cols = md.getColumnCount();</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            for (int i = 0; i &lt; cols; i++) {</span>
<span class="nc" id="L249">              String name = md.getColumnLabel(i + 1);</span>
<span class="nc" id="L250">              print(name + &quot;\t&quot;);</span>
            }
<span class="nc" id="L252">            println(&quot;&quot;);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">              for (int i = 0; i &lt; cols; i++) {</span>
<span class="nc" id="L255">                String value = rs.getString(i + 1);</span>
<span class="nc" id="L256">                print(value + &quot;\t&quot;);</span>
              }
<span class="nc" id="L258">              println(&quot;&quot;);</span>
            }
          }

<span class="fc" id="L262">          command = null;</span>
          try {
<span class="fc" id="L264">            statement.close();</span>
<span class="nc" id="L265">          } catch (Exception e) {</span>
            // Ignore to workaround a bug in Jakarta DBCP
<span class="fc" id="L267">          }</span>
<span class="fc" id="L268">          Thread.yield();</span>
<span class="fc" id="L269">        } else {</span>
<span class="fc" id="L270">          command.append(line);</span>
<span class="fc" id="L271">          command.append(&quot; &quot;);</span>
        }
<span class="fc" id="L273">      }</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">      if (!autoCommit) {</span>
<span class="fc" id="L275">        conn.commit();</span>
      }
<span class="nc" id="L277">    } catch (SQLException e) {</span>
<span class="nc" id="L278">      e.fillInStackTrace();</span>
<span class="nc" id="L279">      printlnError(&quot;Error executing: &quot; + command);</span>
<span class="nc" id="L280">      printlnError(e);</span>
<span class="nc" id="L281">      throw e;</span>
<span class="nc" id="L282">    } catch (IOException e) {</span>
<span class="nc" id="L283">      e.fillInStackTrace();</span>
<span class="nc" id="L284">      printlnError(&quot;Error executing: &quot; + command);</span>
<span class="nc" id="L285">      printlnError(e);</span>
<span class="nc" id="L286">      throw e;</span>
    } finally {
<span class="fc" id="L288">      conn.rollback();</span>
<span class="fc" id="L289">      flush();</span>
    }
<span class="fc" id="L291">  }</span>

  /**
   * Gets the delimiter.
   *
   * @return the delimiter
   */
  private String getDelimiter() {
<span class="fc" id="L299">    return delimiter;</span>
  }

  /**
   * Prints the.
   *
   * @param o
   *          the o
   */
  private void print(Object o) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">    if (logWriter != null) {</span>
<span class="nc" id="L310">      System.out.print(o);</span>
    }
<span class="nc" id="L312">  }</span>

  /**
   * Println.
   *
   * @param o
   *          the o
   */
  private void println(Object o) {
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">    if (logWriter != null) {</span>
<span class="nc" id="L322">      logWriter.println(o);</span>
    }
<span class="fc" id="L324">  }</span>

  /**
   * Println error.
   *
   * @param o
   *          the o
   */
  private void printlnError(Object o) {
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">    if (errorLogWriter != null) {</span>
<span class="nc" id="L334">      errorLogWriter.println(o);</span>
    }
<span class="fc" id="L336">  }</span>

  /**
   * Flush.
   */
  private void flush() {
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">    if (logWriter != null) {</span>
<span class="nc" id="L343">      logWriter.flush();</span>
    }
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">    if (errorLogWriter != null) {</span>
<span class="nc" id="L346">      errorLogWriter.flush();</span>
    }
<span class="fc" id="L348">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>